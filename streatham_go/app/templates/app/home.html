{% extends 'base.html' %} {% load django_bootstrap5 %} {% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'app/home.css' %}" />


<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      // Does this cookie string begin with the name we want?
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}</script>
<div class="card container rounded-0" style = "font-family: Courier New; font-weight: bold; background-color: rgb(255, 240, 220);">
    <div class="card-header" >
      <b>Today's Quest-Giver: {{ building_name }}</b>
    </div>
    <div class="card-body">
      <h5 class="card-title">  </h5>
      <div id="googleMap" style="height:50vh;transform-origin:top;transform:scale(0.95);">

      {{ building_lat|json_script:'lat' }}
      {{ building_lon|json_script:'lon' }}
      {{ building_name|json_script:'name' }}

      <script>
        // Generate google map centred on building
        function myMap() {
          lat = JSON.parse(document.getElementById('lat').textContent);
          lon = JSON.parse(document.getElementById('lon').textContent);
          name = JSON.parse(document.getElementById('name').textContent);

          boundsNorth = 50.740400
          boundsSouth = 50.730000
          boundsEast = -3.524000
          boundsWest = -3.542700


          var mapProp = {
            center: new google.maps.LatLng(lat,lon),
            restriction: {
              latLngBounds: {
                north: boundsNorth,
                south: boundsSouth,
                east: boundsEast,
                west: boundsWest,
              },
              strictBounds: false,
            },
            disableDefaultUI: true,
            zoom:17,
            minZoom: 17,
            maxZoom: 20,
            mapId: "27c6b9a1bc6d90d5"
          };
          var map = new google.maps.Map(document.getElementById("googleMap"),mapProp);
          var iconMarker = {
            url:"{% static 'app\example32.png' %}", 
            labelOrigin: new google.maps.Point(20,-10),
            scaledSize: new google.maps.Size(40, 40)
          }
          var labelMarker = {
            text: name,
            color: "white",
            fontSize: "16px",
            fontFamily: "Courier New",
            className: "maplabel"
          }
          var marker = new google.maps.Marker({position:map.center, label: labelMarker, icon: iconMarker});
          marker.setMap(map);
        }
        </script>

      <script
        src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=myMap"
      ></script>
      </div>

      
      <script>
        function say(msg) {
            document.getElementById('dialogue').innerHTML = msg;
          }

        function updateButtons(responses) {
            document.getElementById('buttons').innerHTML = responses;
        }

        function welcome(){
            say("{{ building_message }}")

            responses = "<button type='button' class='btn btn-danger' onclick='say(\"Insult\")'>Insult</button>" +
            "<button type='button' class='btn btn-success' onclick='getLocation()'>I'm here</button>" +
            "<button type='button' class='btn btn-warning' onclick='say(\"Any Tips?\")'>Any Tips?</button>"

            updateButtons(responses)
        }

        function ready(){
            say("I have a question for you. Are you ready?")

            responses = "<button type='button' class='btn btn-success' onclick='question()'>Yes</button>" +
            "<button type='button' class='btn btn-danger' onclick='welcome()'>No</button>"
            updateButtons(responses)
        }

        function question(){
            message = "{{ question }} <br> <br>" +
            "A) " + "{{ a }} <br>" +
            "B) " + "{{ b }} <br>" +
            "C) " + "{{ c }} <br>" +
            "D) " + "{{ d }}"
            say(message)
            
            responses = "<button type='button' class='btn btn-warning' onclick='say(\"a\")'>A</button>" +
            "<button type='button' class='btn btn-primary' onclick='say(\"b\")'>B</button>" +
            "<button type='button' class='btn btn-danger' onclick='say(\"c\")'>C</button>" +
            "<button type='button' class='btn btn-success' onclick='say(\"d\")'>D</button>"

            updateButtons(responses)
        }


        // location checking

        function error(err){
            console.warn(`ERROR(${err.code}): ${err.message}`);
            say("Sorry, we couldn't find your location. Please try again later.")
          }
          function success(pos){
            data = pos.coords.longitude + "," + pos.coords.latitude
            // TODO: check if the user is within the bounds of the map on the backend
            if (true){
              ready()
            };

          }
          function getLocation(){
            const options = {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            };
            navigator.geolocation.getCurrentPosition(success, error, options);
          }
      </script>





  <div class="container-fluid">
      <div class="row g-2 form-group">
          <div class="col-2 col-lg-1 mx-auto" style="image-rendering: pixelated">
            <img src="{% static 'app\example32.png' %}" class="img-fluid mx-auto" alt="icon" style="width: 100%" onload='welcome()'>
          </div>
          <div class="col" id="dialogue">
          </div>
      </div>
      <div style="text-align: center;">
        <br>
        <div id="buttons" class="btn-group mr-2 rounded-0" role="group" aria-label="First group">

        </div>
      </div>

  </div>
  <br>
  <div class="card-footer text-muted">
    Time Remaining: 12h 29m 47s
  </div>
  </div>

{% endblock %}
