{% extends 'base.html' %} {% load django_bootstrap5 %} {% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'app/home.css' %}" />

{% if messages %}
    {% for message in messages %}
        <p>{{ message }}</p>
    {% endfor %}
{% else %}

<script>  
  var location_latitude =[]
  var location_longitude =[]
  var location_names = []
  var location_icons = []
  var location_messages = []
</script>
{% for location in locations %}
    <script>  
      // this is a horrible implementation! Want to generate it as a list of JS object on the backend instead...
      location_latitude.push('{{ location.latitude }}')
      location_longitude.push('{{ location.longitude }}')
      location_names.push('{{ location.name }}')
      location_icons.push('{{ location.icon.url }}')
      location_messages.push('{{ location.location_message }}')
    </script>
{% endfor %}
<script src=" {% static 'app\conversation.js' %} "></script>

<div class="card container rounded-0" style = "height:100vh;font-family: Courier New; font-weight: bold; background-color: rgb(255, 240, 220);">
    <div class="card-header" >
      <b>Today's Quest-Giver:</b>
    </div>
    <div class="card-body">
      <h5 class="card-title"> </h5>
      <div id="googleMap" style="height:50vh;transform-origin:top;transform:scale(0.95);image-rendering:pixelated;">

      <script>
        // Generate google map
        function myMap() {
          boundsNorth = 50.740400
          boundsSouth = 50.730000
          boundsEast = -3.524000
          boundsWest = -3.542700


          var mapProp = {
            // ToDo: Centre it near the player if in range
            center: new google.maps.LatLng(50.735400,-3.532700),
            restriction: {
              latLngBounds: {
                north: boundsNorth,
                south: boundsSouth,
                east: boundsEast,
                west: boundsWest,
              },
              strictBounds: false,
            },
            disableDefaultUI: true,
            zoom:17,
            minZoom: 17,
            maxZoom: 20,
            mapId: "27c6b9a1bc6d90d5"
          };
          var map = new google.maps.Map(document.getElementById("googleMap"),mapProp);
          
          for (let i = 0; i < location_names.length; i++) {
            var iconMarker = {
              url: location_icons[i], 
              labelOrigin: new google.maps.Point(20,-10),
              scaledSize: new google.maps.Size(40, 40)
            }
            var labelMarker = {
              text: location_names[i],
              color: "white",
              fontSize: "16px",
              fontFamily: "Courier New",
              className: "maplabel"
            }
            
            var positionMarker = {
              lat: Number(location_latitude[i]),
              lng: Number(location_longitude[i])
            }
            var marker = new google.maps.Marker({position: positionMarker, label: labelMarker, icon: iconMarker, animation:google.maps.Animation.DROP});
            marker.setMap(map);
            google.maps.event.addListener(marker, 'click', function() {
              // change icon, whos talking, maybe pass i to seperate handler function...
              // consider the following code to be placeholder, along with conversation.js
              icon = '<img src="' + location_icons[i] + '"class="img-fluid mx-auto" alt="icon" style="width:100%;image-rendering:pixelated">';
              document.getElementById('icon').innerHTML = icon;
              welcomeScene(location_messages[i])
            });
          }
        }
        </script>



      <script
        src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=myMap"
      ></script>
      </div>


  <div class="container-fluid">
      <div class="row g-2 form-group">
          <div class="col-3 col-lg-1 mx-auto" id ="icon" style="image-rendering: pixelated">
          </div>
          <div class="col" id="dialogue">
          </div>
      </div>
      <div style="text-align: center;">
        <br>
        <div id="buttons" class="btn-group mr-2 rounded-0" role="group" aria-label="First group">

        </div>
      </div>
  </div>
  <br>
  <div class="card-footer text-muted">
    Time Remaining: 12h 29m 47s
  </div>
  </div>
{% endif %}

{% endblock %}